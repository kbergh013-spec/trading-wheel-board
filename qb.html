<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QB — Trading Wheels Fantasy Stock Ball</title>
<style>
  :root{
    --bg: rgba(10,12,16,0.55);
    --panel: rgba(24,28,36,0.92);
    --text: #eaf0ff;
    --muted:#9fb0d0;
    --accent:#50e3c2;
    --taken:#ff6b6b;
    --chip:#1e2533;
    --chip-border:#2b3447;
    --owner:#86b5ff;
  }
  html,body{margin:0;background:transparent;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
  .wrap{position:relative;padding:16px;background:var(--bg);border-radius:16px;overflow:hidden;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
  header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .logos{display:flex;align-items:center;gap:6px}
  .logo{height:28px;display:none}
  .logo.stock{height:22px;opacity:.9}
  h1{font-size:20px;margin:0;font-weight:800;letter-spacing:.3px}
  .legend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:13px;margin:6px 0 10px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot-open{background:var(--accent)} .dot-taken{background:var(--taken)}
  .layout{display:grid;grid-template-columns:2.1fr 1fr;gap:12px;align-items:start}
  .card{background:var(--panel);border:1px solid #2a3346;border-radius:14px;padding:12px}
  .card h2{margin:0 0 10px;font-size:16px;color:var(--accent);font-weight:800}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:var(--chip);border:1px solid var(--chip-border);
        border-radius:999px;user-select:none;font-weight:800}
  .chip small{color:var(--muted);font-weight:700}
  .chip .price{color:#b7c8ff}
  .chip .pct{font-weight:900}
  .chip .pct.up{color:#25d29f} .chip .pct.down{color:#ff7c7c}
  .chip.taken{border-color:#3b1f24;background:#26171a;color:#ffdede}
  .chip .owner{color:var(--owner);margin-left:6px}
  /* Picks panel */
  .owners{display:flex;flex-direction:column;gap:12px}
  .ownerCard h3{margin:0 0 8px;font-size:15px;color:#b8c8ff}
  .ownerList{display:flex;flex-wrap:wrap;gap:8px}
  /* Large centered watermark behind everything */
  .wm{
    position:fixed; inset:0; z-index:0; pointer-events:none; user-select:none;
    display:flex;align-items:center;justify-content:center;
  }
  .wm img{max-width:92vw;max-height:92vh;opacity:0.09;filter:grayscale(8%) contrast(105%);object-fit:contain}
  /* Bring main UI above watermark */
  .wrap, header, .layout, .card{position:relative; z-index:2}
</style>
</head>
<body>
  <!-- Watermark -->
  <div class="wm"><img id="wm" alt="Trading Wheels watermark"></div>

  <div class="wrap">
    <header>
      <div class="logos">
        <img id="twLogo" class="logo tw" alt="Trading Wheels">
        <img id="stockLogo" class="logo stock" alt="Stock">
      </div>
      <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
    </header>

    <div class="legend">
      <div class="dot dot-open"></div><span>Available</span>
      <div class="dot dot-taken"></div><span>Taken</span>
    </div>

    <div class="layout">
      <!-- LEFT: Only the QB category -->
      <div>
        <div id="qb-card" class="card" style="min-height:80px">
          <h2 id="qb-title">QB (MAG7 + NFLX)</h2>
          <div id="qb-chips" class="chips"></div>
        </div>
      </div>

      <!-- RIGHT: Picks by Owner -->
      <div>
        <div class="card">
          <h2>Picks by Owner</h2>
          <div id="owners" class="owners"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** CONFIG FOR THIS PAGE **/
const CAT_KEY = 'qb';               // <- ONLY change this when you duplicate for rb/wr/te/def
const POLL_MS = 5000;               // refresh CSV every 5s (matching your index)
const params  = new URLSearchParams(location.search);
const CSV_URL = params.get('csv');  // your published CSV link
/* logos (optional) */
const TW_LOGO  = params.get('twlogo')  || 'Trading%20Wheels.png';
const STOCKLOGO= params.get('stocklogo') || 'stock_logo.png';

/* hook up logos + watermark */
const twLogoEl = document.getElementById('twLogo');
const stockEl  = document.getElementById('stockLogo');
const wmEl     = document.getElementById('wm');
if (TW_LOGO){ twLogoEl.src = TW_LOGO; twLogoEl.style.display='block'; wmEl.src = TW_LOGO; }
if (STOCKLOGO){ stockEl.src = STOCKLOGO; stockEl.style.display='block'; }

/* ---------- CSV Parser ---------- */
function csvParseLine(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else q=!q;
    }else if(ch===',' && !q){ out.push(cur); cur=""; }
    else cur+=ch;
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF){ text=text.slice(1); }
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
  const rows  = lines.map(csvParseLine);

  const cats = {};
  const ownerMap = {};
  const header = rows[0].map(h=>h.trim().toLowerCase());
  // Allow gviz “Title, …” row or extra headers — skip anything until we find a header with category_key
  let start = 0;
  if(!header.includes('category_key')){
    for(let i=1;i<rows.length;i++){
      const h = rows[i].map(x=>x.trim().toLowerCase());
      if(h.includes('category_key')){ start=i; break; }
    }
  }
  for(let i=start+1;i<rows.length;i++){
    const c = rows[i];
    if(!c || c.length<4) continue;
    const k   = (c[0]||"").trim().toLowerCase();
    const name= (c[1]||"").trim();
    const sym = (c[2]||"").trim();
    const lab = (c[3]||"").trim();
    const taken = (c[4]||"").toString().trim().toLowerCase();
    const owner = (c[5]||"").trim();
    const price = (c[6]||"").trim();
    const pct   = (c[7]||"").trim();

    if(!(k && sym)) continue;

    if(!cats[k]) cats[k]={name,open:[],taken:[]};
    const isTaken = (taken==="1"||taken==="true"||taken==="yes"||taken==="y");
    const item={symbol:sym,label:lab,owner,price,change_pct:pct};
    (isTaken?cats[k].taken:cats[k].open).push(item);

    if(isTaken && owner){
      if(!ownerMap[owner]) ownerMap[owner]=[];
      ownerMap[owner].push({symbol:sym,label:lab,price,change_pct:pct});
    }
  }
  return {cats, ownerMap};
}

/* ---------- Render helpers ---------- */
function chipHTML(it, isTaken){
  const p = (it.price||"").replace(/^\$/,'');
  const pct = (it.change_pct||"").replace('%','');
  const pctNum = parseFloat(pct);
  const pctCls = isFinite(pctNum) ? (pctNum>=0?'up':'down') : '';
  const priceSpan = p?`<span class="price">$${p}</span>`:'';
  const pctSpan   = pct?`<span class="pct ${pctCls}">${pctNum>0?'+':''}${pct}%</span>`:'';
  const ownerSpan = (isTaken && it.owner)?`<span class="owner">— ${it.owner}</span>`:'';
  const labelSmall= it.label?`<small>${it.label}</small>`:'';
  return `<div class="chip${isTaken?' taken':''}">
    <strong>${it.symbol}</strong> ${labelSmall} ${priceSpan} ${pctSpan} ${ownerSpan}
  </div>`;
}

function renderQB(cat, ownerMap){
  const title = document.getElementById('qb-title');
  const chips = document.getElementById('qb-chips');
  title.textContent = cat?.name || "QB";
  chips.innerHTML = '';
  (cat?.open||[]).forEach(it => chips.insertAdjacentHTML('beforeend', chipHTML(it,false)));
  (cat?.taken||[]).forEach(it => chips.insertAdjacentHTML('beforeend', chipHTML(it,true)));

  // Owners
  const ownersDiv = document.getElementById('owners');
  ownersDiv.innerHTML='';
  const names = Object.keys(ownerMap).sort();
  if(names.length===0){
    ownersDiv.innerHTML = `<div style="color:var(--muted);font-size:13px">No picks yet.</div>`;
  } else {
    names.forEach(n=>{
      const box = document.createElement('div');
      box.className='ownerCard';
      box.innerHTML = `<h3>${n}</h3><div class="ownerList"></div>`;
      const list = box.querySelector('.ownerList');
      ownerMap[n].forEach(it => list.insertAdjacentHTML('beforeend', chipHTML(it,true)));
      ownersDiv.appendChild(box);
    });
  }
}

/* ---------- Poll loop (CSV only, no external price API) ---------- */
let lastText = '';
async function sync(){
  if(!CSV_URL) return;
  try{
    const res = await fetch(CSV_URL + (CSV_URL.includes('?')?'&':'?') + 'cachebust=' + Date.now());
    const text = await res.text();
    if(text && text!==lastText){
      lastText = text;
      const {cats, ownerMap} = parseCSV(text);
      renderQB(cats[CAT_KEY], ownerMap);
    }
  }catch(e){
    // silent: keep previous state, no on-screen retry banner
  }
}
sync(); setInterval(sync, POLL_MS);
</script>
</body>
</html>
