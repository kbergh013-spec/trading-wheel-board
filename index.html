<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trading Wheels Fantasy Stock Ball — Live Draft Board</title>
<style>
  :root {
    --bg:#76787a;
    --panel:rgba(28,32,38,0.01); /* more transparent! */
    --chip:rgba(35,39,51,0.85);
    --chip-border:#2f333d;
    --text:#cfd4e0;
    --muted:#9ba0ad;
    --accent:#47e8c0;
  }
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background-image: url("Fantasy_Background.png");
    background-repeat: no-repeat;
    background-position: center center;
    background-size: cover;
    background-attachment: fixed;
    background-blend-mode: normal;
  }

  .wrap{
    position:relative;
    padding:16px;
    background:var(--bg);
    border-radius:16px;
    overflow:hidden;
    backdrop-filter:blur(6px);
    -webkit-backdrop-filter:blur(6px);
    z-index:1; /* sits above the watermark */
  }

  header{
    position:relative;
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
    z-index:2;
  }

  .logos{display:flex;align-items:center;gap:8px;}
  img.logo{height:34px;object-fit:contain;display:none;}
  img.logo.stock{height:26px;opacity:.9;}
  header h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.4px;}

  .legend{
    display:flex;
    gap:12px;
    align-items:center;
    margin:6px 0 12px;
    color:var(--muted);
    font-size:13px;
    z-index:2;
  }

  .dot{width:10px;height:10px;border-radius:50%;}
  .dot-open{background:var(--accent);}
  .dot-taken{background:var(--taken);}

  .layout{
    display:grid;
    grid-template-columns: 2.5fr 1fr;
    gap:12px;
    align-items:start;
    z-index:2;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:12px;
  }

  .card{
    background:var(--panel);
    border:1px solid #2a3346;
    border-radius:14px;
    padding:12px;
    min-height:64px;
  }

  .card h2{
    margin:0 0 10px;
    font-size:17px;
    font-weight:800;
    letter-spacing:.35px;
    color:var(--accent);
  }

  .chips{display:flex;flex-wrap:wrap;gap:8px;}

  /* big rounded “bubble” chips */
  .chip{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:10px 14px;
    background:var(--chip);
    border:1px solid var(--chip-border);
    border-radius:999px;
    user-select:none;
    transition:all .2s;
    font-weight:800;
    font-size:28px; /* you can tweak */
    letter-spacing:.3px;
  }

  .chip.taken{
    opacity:1;
    border-color:#3b1f24;
    background:#26171a;
    color:#ffdede;
  }

  .chip .owner{
    font-weight:700;
    color:var(--owner);
    margin-left:6px;
    opacity:.95;
  }

  .owners{display:flex;flex-direction:column;gap:12px;}
  .ownerCard h3{margin:0 0 8px;font-size:15px;color:#b8c8ff;}
  .ownerList{display:flex;flex-wrap:wrap;gap:8px;}

  /* full-screen background (same behavior as QB page) */
  .wm{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    z-index:0; /* sits behind everything */
  }
  .wm img{
    max-width:85vw;
    max-height:85vh;
    opacity:var(--wm-opacity);
    object-fit:contain;
    filter:grayscale(10%) brightness(115%);
  }
</style>
</head>
<body>
  <div class="wrap" id="wrap">
    <header>
      <div class="logos">
        <img id="twLogo" class="logo tw" alt="Trading Wheels"/>
        <img id="stockLogo" class="logo stock" alt="Stock"/>
      </div>
      <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
    </header>

    <div class="legend">
      <div class="dot dot-open"></div><span>Available</span>
      <div class="dot dot-taken"></div><span>Taken</span>
    </div>

    <div class="layout">
      <!-- LEFT: categories -->
      <div>
        <div class="grid" id="grid-top"></div>
      </div>

      <!-- RIGHT: picks + defense -->
      <div>
        <div class="card">
          <h2>Picks by Owner</h2>
          <div class="owners" id="owners"></div>
        </div>
        <div id="defense-footer" class="card" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- background watermark -->
  <div class="wm" id="wm"><img id="wmImg" alt="Background"/></div>

<script>
/* ---------- Params ---------- */
const params    = new URLSearchParams(location.search);
const CSV_URL   = params.get("csv") || "";
const TW_LOGO   = params.get("twlogo")   || "Trading%20Wheels.png";
const STOCKLOGO = params.get("stocklogo")|| "stock_logo.png";
/* NEW: background & opacity—defaults match your QB page */
const BG_IMAGE  = params.get("bg") || "Fantasy_Background.png";
const WM_OPAC   = params.get("wm"); // e.g. 0.12

const POLL_MS   = 5000;

/* ---------- Elements ---------- */
const twLogoEl    = document.getElementById("twLogo");
const stockLogoEl = document.getElementById("stockLogo");
const wmImgEl     = document.getElementById("wmImg");

/* show logos + set background image */
twLogoEl.src = TW_LOGO;            twLogoEl.style.display = "block";
stockLogoEl.src = STOCKLOGO;       stockLogoEl.style.display = "block";
wmImgEl.src = BG_IMAGE;

/* apply optional opacity override from URL */
if (WM_OPAC && !Number.isNaN(parseFloat(WM_OPAC))) {
  document.documentElement.style.setProperty("--wm-opacity", parseFloat(WM_OPAC));
}

/* ---------- CSV helpers ---------- */
function csvParseLine(line){
  const out=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQuotes && line[i+1]==='\"'){ cur+='\"'; i++; }
      else inQuotes = !inQuotes;
    }else if(ch===',' && !inQuotes){
      out.push(cur); cur="";
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  return out;
}

/* Robust parser: skips “Title, …” and header row “category_key, …” */
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF){ text=text.slice(1); }
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n")
                    .split("\n").filter(l=>l.trim().length>0);
  const rows  = lines.map(csvParseLine);

  const cats = {};
  const ownerMap = {};

  for(const cols of rows){
    if(!cols || cols.length < 4) continue;

    const c0 = (cols[0]||"").trim().toLowerCase();
    if(c0 === "title" || c0 === "category_key") continue;

    const k     = (cols[0]||"").trim();   // category_key
    const n     = (cols[1]||"").trim();   // category_name
    const sym   = (cols[2]||"").trim();   // symbol
    const taken = (cols[4]||"").toString().trim().toLowerCase(); // taken
    const owner = (cols[5]||"").trim();   // owner

    if(!(k && n && sym)) continue;

    if(!cats[k]) cats[k] = {name:n, key:k, open:[], taken:[]};
    const isTaken = (taken==="1"||taken==="true"||taken==="yes"||taken==="y");
    const item = {symbol:sym, owner};
    (isTaken ? cats[k].taken : cats[k].open).push(item);

    if(isTaken && owner){
      ownerMap[owner] ??= [];
      ownerMap[owner].push({symbol:sym, cat:n});
    }
  }

  return {categories:Object.values(cats), ownerMap};
}

/* ---------- Rendering ---------- */
function makeChip(it, isTaken){
  const d = document.createElement("div");
  d.className = "chip" + (isTaken ? " taken" : "");
  const own = isTaken && it.owner ? ` <span class="owner">— ${it.owner}</span>` : "";
  d.innerHTML = `<strong>${it.symbol}</strong>${own}`;
  return d;
}

function renderBoard(categories){
  const top = document.getElementById('grid-top');      top.innerHTML = "";
  const def = document.getElementById('defense-footer');def.innerHTML = "";

  let defense = null;
  const main = [];

  for(const c of categories){
    if ((c.key||"").toLowerCase()==="def" || /defense/i.test(c.name||"")) defense = c;
    else main.push(c);
  }

  // main categories
  for(const cat of main){
    const card = document.createElement('div'); card.className = "card";
    const h2   = document.createElement('h2');  h2.textContent = cat.name; card.appendChild(h2);
    const chips= document.createElement('div'); chips.className = "chips";
    cat.open.forEach(it => chips.appendChild(makeChip(it,false)));
    cat.taken.forEach(it => chips.appendChild(makeChip(it,true)));
    card.appendChild(chips); top.appendChild(card);
  }

  // defense on the right panel
  if(defense){
    const h2 = document.createElement('h2'); h2.textContent = defense.name; def.appendChild(h2);
    const chips = document.createElement('div'); chips.className = "chips";
    defense.open.forEach(it => chips.appendChild(makeChip(it,false)));
    defense.taken.forEach(it => chips.appendChild(makeChip(it,true)));
    def.appendChild(chips);
  }
}

function renderOwners(ownerMap){
  const container = document.getElementById('owners'); container.innerHTML = "";
  const owners = Object.keys(ownerMap).sort();
  if(owners.length===0){
    container.innerHTML = `<div style="color:var(--muted);font-size:13px">No picks yet.</div>`;
    return;
  }
  for(const name of owners){
    const oc = document.createElement('div'); oc.className = "ownerCard";
    const h3 = document.createElement('h3'); h3.textContent = name; oc.appendChild(h3);
    const list = document.createElement('div'); list.className = "ownerList";
    ownerMap[name].forEach(it=>{
      const chip = document.createElement('div'); chip.className = "chip taken";
      chip.innerHTML = `<strong>${it.symbol}</strong>`;
      list.appendChild(chip);
    });
    oc.appendChild(list); container.appendChild(oc);
  }
}

/* ---------- Poll loop ---------- */
async function sync(){
  try{
    if(!CSV_URL) return;
    const res = await fetch(CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "cachebust=" + Date.now());
    const text = await res.text();
    const {categories, ownerMap} = parseCSV(text);
    renderBoard(categories);
    renderOwners(ownerMap);
  }catch(e){
    console.error(e);
  }
}
sync(); setInterval(sync, POLL_MS);
</script>
</body>
</html>
