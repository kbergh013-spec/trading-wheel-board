<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Wheels Fantasy Stock Ball — Live Draft Board</title>
<style>
  :root{
    --bg: rgba(10,12,16,0.55);
    --panel: rgba(24,28,36,0.92);
    --text: #eaf0ff;
    --muted: #9fb0d0;
    --accent: #50e3c2;
    --taken:#ff6b6b;
    --chip:#1e2533;
    --chip-border:#2b3447;
    --owner:#86b5ff;
  }
  html,body{
    margin:0; padding:0; background:transparent;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    color:var(--text);
  }
  .wrap{position:relative; padding:16px; background:var(--bg); border-radius:16px; overflow:hidden;
        backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);}

  /* Header + logos */
  header{position:relative; display:flex; align-items:center; gap:12px; margin-bottom:10px; z-index:2;}
  .logos{display:flex; align-items:center; gap:8px}
  img.logo{height:34px; width:auto; object-fit:contain}
  img.logo.stock{height:26px; opacity:.9}
  header h1{font-size:22px;margin:0;letter-spacing:.4px; font-weight:800}

  .legend{position:relative; display:flex; gap:12px; align-items:center; margin:6px 0 12px; color:var(--muted); font-size:13px; z-index:2}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot-open{background:var(--accent)} .dot-taken{background:var(--taken)}

  /* Layout: left = board, right = owners */
  .layout{position:relative; display:grid; grid-template-columns: 2.5fr 1fr; gap:12px; align-items:start; z-index:2}

  /* Category grid */
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px}

  /* Cards & chips */
  .card{background:var(--panel); border:1px solid #2a3346; border-radius:14px; padding:12px; min-height:80px}
  .card h2{margin:0 0 10px; font-size:16px; font-weight:800; letter-spacing:.4px; color:var(--accent)}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:var(--chip);
        border:1px solid var(--chip-border); border-radius:999px; user-select:none; transition:all .2s; font-weight:700}
  .chip small{color:var(--muted); font-weight:600}
  .chip.taken{opacity:1; border-color:#3b1f24; background:#26171a; color:#ffdede}
  .chip .owner{font-weight:700; color:var(--owner); margin-left:6px; opacity:.95}

  /* Owners panel */
  .owners{display:flex; flex-direction:column; gap:12px}
  .ownerCard h3{margin:0 0 10px; font-size:15px; color:#b8c8ff}
  .ownerList{display:flex; flex-wrap:wrap; gap:8px}

  /* Defense footer (full width under left grid) */
  .defense-footer{margin-top:12px}

  /* Screen-wide watermark (TW logo) */
  #sideMark{
    position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    width:100vw; height:auto; max-width:100vw; max-height:100vh;
    object-fit:contain; opacity:.05; filter:grayscale(10%) brightness(115%);
    z-index:0; pointer-events:none; user-select:none;
  }

  /* Ensure content sits above watermark */
  .main, .categoryCol, .rightCol, header { position:relative; z-index:2; }

  /* Timestamp */
  #timestamp{
    position:fixed; right:16px; bottom:8px;
    font-size:13px; color:#8fa3c8; opacity:.65; z-index:9999;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logos">
        <img id="twLogo" class="logo tw" alt="Trading Wheels"/>
        <img id="stockLogo" class="logo stock" alt="Stock"/>
      </div>
      <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
    </header>

    <div class="legend">
      <div class="dot dot-open"></div><span>Available</span>
      <div class="dot dot-taken"></div><span>Taken</span>
    </div>

    <div class="layout">
      <!-- LEFT: main board -->
      <div>
        <div class="grid" id="grid-top"></div>
        <div id="defense-footer"></div>
      </div>

      <!-- RIGHT: picks by owner -->
      <div class="rightCol">
        <div class="card">
          <h2>Picks by Owner</h2>
          <div class="owners" id="owners"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Watermark -->
  <img id="sideMark" alt="Trading Wheels Watermark"/>

  <!-- Timestamp -->
  <div id="timestamp">Last updated: —</div>

<script>
/* ---------- Params & asset defaults ---------- */
const params    = new URLSearchParams(location.search);
const CSV_URL   = params.get("csv"); // REQUIRED
// If not supplied via ?twlogo=... or ?stocklogo=..., fall back to files in repo root:
const TW_LOGO   = params.get("twlogo")   || "Trading Wheels.png";   // matches your repo filename
const STOCKLOGO = params.get("stocklogo")|| "stock_logo.png";

const POLL_MS   = 5000;

/* ---------- DOM refs ---------- */
const twLogoEl    = document.getElementById('twLogo');
const stockLogoEl = document.getElementById('stockLogo');
const sideMarkEl  = document.getElementById('sideMark');
const tsEl        = document.getElementById('timestamp');

if (TW_LOGO){
  twLogoEl.src = TW_LOGO;
  sideMarkEl.src = TW_LOGO; // use same file for watermark
}
if (STOCKLOGO){
  stockLogoEl.src = STOCKLOGO;
}

/* ---------- CSV parsing helpers ---------- */
function csvParseLine(line){
  const out=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQuotes && line[i+1]==='\"'){ cur+='\"'; i++; }
      else inQuotes = !inQuotes;
    }else if(ch===',' && !inQuotes){
      out.push(cur); cur="";
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  return out;
}

// Robust parser: skips Google gviz "Title" row and header row
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF){ text=text.slice(1); }
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n")
                    .split("\n").filter(l=>l.trim().length>0);
  const rows  = lines.map(csvParseLine);

  const cats = {};
  const ownerMap = {};

  for(let i=0;i<rows.length;i++){
    const cols = rows[i];
    if(!cols || cols.length===0) continue;

    const c0 = (cols[0]||"").trim().toLowerCase();
    if(c0 === "title" || c0 === "category_key") continue;  // skip title/header

    const k   = (cols[0]||"").trim();      // category_key
    const n   = (cols[1]||"").trim();      // category_name
    const sym = (cols[2]||"").trim();      // symbol
    const lab = (cols[3]||"").trim();      // label
    const taken = (cols[4]||"").toString().trim().toLowerCase(); // taken
    const owner = (cols[5]||"").trim();    // owner

    if(!(k&&n&&sym)) continue;

    if(!cats[k]) cats[k] = {name:n, key:k, open:[], taken:[]};
    const isTaken = (taken==="1"||taken==="true"||taken==="yes"||taken==="y");
    const item = {symbol:sym, label:lab, owner};
    (isTaken ? cats[k].taken : cats[k].open).push(item);

    if(isTaken && owner){
      if(!ownerMap[owner]) ownerMap[owner] = [];
      ownerMap[owner].push({symbol:sym,label:lab,cat:n});
    }
  }

  return {categories:Object.values(cats), ownerMap};
}

/* ---------- Rendering ---------- */
function makeChip(it, isTaken){
  const chip = document.createElement('div');
  chip.className = "chip" + (isTaken ? " taken" : "");
  const label = (it.label||"").trim();
  const own   = (it.owner && isTaken) ? `<span class="owner">— ${it.owner}</span>` : "";
  chip.innerHTML = `<strong>${(it.symbol||"").trim()}</strong> ${label?`<small>${label}</small>`:""} ${own}`;
  return chip;
}

function renderBoard(categories){
  const top = document.getElementById('grid-top');      top.innerHTML = "";
  const def = document.getElementById('defense-footer');def.innerHTML = "";

  let defense = null;
  const topCats = [];
  categories.forEach(c=>{
    if ((c.key||"").toLowerCase()==="def" || /defense/i.test(c.name||"")){
      defense = c;
    } else {
      topCats.push(c);
    }
  });

  topCats.forEach(cat=>{
    const card = document.createElement('div'); card.className = "card";
    const h2 = document.createElement('h2'); h2.textContent = cat.name; card.appendChild(h2);
    const chips = document.createElement('div'); chips.className = "chips";
    cat.open.forEach(it => chips.appendChild(makeChip(it,false)));
    cat.taken.forEach(it => chips.appendChild(makeChip(it,true)));
    card.appendChild(chips); top.appendChild(card);
  });

  if(defense){
    const card = document.createElement('div'); card.className = "card defense-footer";
    const h2 = document.createElement('h2'); h2.textContent = defense.name; card.appendChild(h2);
    const chips = document.createElement('div'); chips.className = "chips";
    defense.open.forEach(it => chips.appendChild(makeChip(it,false)));
    defense.taken.forEach(it => chips.appendChild(makeChip(it,true)));
    card.appendChild(chips); def.appendChild(card);
  }
}

function renderOwners(ownerMap){
  const container = document.getElementById('owners'); container.innerHTML = "";
  const owners = Object.keys(ownerMap).sort();
  if(owners.length===0){
    container.innerHTML = `<div style="color:var(--muted);font-size:13px">No picks yet.</div>`;
    return;
  }
  owners.forEach(name=>{
    const oc = document.createElement('div'); oc.className="ownerCard";
    const h3 = document.createElement('h3'); h3.textContent = name; oc.appendChild(h3);
    const list = document.createElement('div'); list.className="ownerList";
    ownerMap[name].forEach(it=>{
      const chip = document.createElement('div'); chip.className="chip taken";
      chip.innerHTML = `<strong>${it.symbol}</strong> <small>${it.label}</small>`;
      list.appendChild(chip);
    });
    oc.appendChild(list); container.appendChild(oc);
  });
}

/* ---------- Sync + timestamp ---------- */
async function syncOnce(){
  if(!CSV_URL) return;
  const res = await fetch(CSV_URL + ((CSV_URL.includes("?")?"&":"?")+"cachebust="+Date.now()));
  const text = await res.text();
  const {categories, ownerMap} = parseCSV(text);
  renderBoard(categories);
  renderOwners(ownerMap);
  const ts = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  tsEl.textContent = `Last updated: ${ts}`;
}

syncOnce();
setInterval(syncOnce, POLL_MS);
</script>
</body>
</html>
