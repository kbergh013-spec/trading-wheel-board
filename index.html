<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Wheels Fantasy Stock Ball — Live Draft Board</title>
<style>
:root{
  --bg: rgba(10,12,16,0.6);
  --panel: rgba(24,28,36,0.92);
  --text: #eaf0ff;
  --muted: #9fb0d0;
  --accent: #50e3c2;
  --taken:#ff6b6b;
  --chip:#1e2533;
  --chip-border:#2b3447;
  --owner:#86b5ff;
}
html,body{
  margin:0;
  padding:0;
  background:transparent;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
  color:var(--text);
}
.wrap{
  position:relative;
  padding:16px;
  background:var(--bg);
  border-radius:16px;
  overflow:hidden;
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
}

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
header .logos{
  display:flex;
  align-items:center;
  gap:10px;
}
header img{
  height:34px;
  width:auto;
  object-fit:contain;
}
header h1{
  font-size:22px;
  font-weight:800;
  letter-spacing:.4px;
  text-align:center;
  flex:1;
}
.legend{
  display:flex;
  gap:12px;
  align-items:center;
  margin:6px 0 12px;
  color:var(--muted);
  font-size:13px;
}
.dot{width:10px;height:10px;border-radius:50%}
.dot-open{background:var(--accent)}
.dot-taken{background:var(--taken)}

/* Layout: left board + right column */
.layout{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:12px;
  align-items:start;
}

/* Cards */
.card{
  background:var(--panel);
  border:1px solid #2a3346;
  border-radius:14px;
  padding:12px;
}
.card h2{
  margin:0 0 10px;
  font-size:16px;
  font-weight:800;
  color:var(--accent);
}
.chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  background:var(--chip);
  border:1px solid var(--chip-border);
  border-radius:999px;
  font-weight:700;
}
.chip small{color:var(--muted);font-weight:600}
.chip.taken{border-color:#3b1f24;background:#26171a;color:#ffdede}
.chip .owner{font-weight:700;color:var(--owner);margin-left:6px}

/* Owners + Defense on right */
.rightCol{display:flex;flex-direction:column;gap:12px}
.owners{display:flex;flex-direction:column;gap:12px}
.ownerCard h3{margin:0 0 10px;font-size:15px;color:#b8c8ff}
.ownerList{display:flex;flex-wrap:wrap;gap:8px}

/* Background watermark */
.watermark{
  position:fixed;
  bottom:20px;
  right:20px;
  width:300px;
  opacity:0.05;
  pointer-events:none;
  user-select:none;
  filter:brightness(130%);
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logos">
      <img src="https://raw.githubusercontent.com/kbergh013-spec/trading-wheel-board/main/Trading Wheels.png" alt="Trading Wheels">
    </div>
    <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
    <div class="logos">
      <img src="https://raw.githubusercontent.com/kbergh013-spec/trading-wheel-board/main/stock_logo.png" alt="Stock Logo">
    </div>
  </header>

  <div class="legend">
    <div class="dot dot-open"></div><span>Available</span>
    <div class="dot dot-taken"></div><span>Taken</span>
  </div>

  <div class="layout">
    <!-- LEFT: main categories -->
    <div>
      <div class="grid" id="grid-top"></div>
    </div>

    <!-- RIGHT: Picks and Defense -->
    <div class="rightCol">
      <div class="card">
        <h2>Picks by Owner</h2>
        <div class="owners" id="owners"></div>
      </div>
      <div class="card" id="defense-footer"></div>
    </div>
  </div>
</div>

<img src="https://raw.githubusercontent.com/kbergh013-spec/trading-wheel-board/main/trading_wheels_logo.png" class="watermark" alt="TW Watermark"/>

<script>
const params = new URLSearchParams(location.search);
const CSV_URL = params.get("csv");
const POLL_MS = 5000;

function csvParseLine(line){
  const out=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){if(inQuotes && line[i+1]==='\"'){cur+='\"';i++;}else inQuotes=!inQuotes;}
    else if(ch===',' && !inQuotes){out.push(cur);cur="";}
    else cur+=ch;
  }
  out.push(cur);
  return out;
}

function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  const lines=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
  const rows=lines.map(csvParseLine);
  const cats={}; const ownerMap={};

  for(let i=1;i<rows.length;i++){
    const c=rows[i];
    const k=(c[0]||"").trim(), n=(c[1]||"").trim();
    const sym=(c[2]||"").trim(), lab=(c[3]||"").trim();
    const taken=(c[4]||"").trim().toLowerCase();
    const owner=(c[5]||"").trim();
    const price=(c[6]||"").trim(), pct=(c[7]||"").trim();

    if(!(k&&n&&sym)) continue;
    if(!cats[k]) cats[k]={name:n,key:k,open:[],taken:[]};

    const isTaken=(taken==="1"||taken==="true"||taken==="yes"||taken==="y");
    const item={symbol:sym,label:lab,owner,price,change_pct:pct};
    (isTaken?cats[k].taken:cats[k].open).push(item);

    if(isTaken && owner){
      if(!ownerMap[owner]) ownerMap[owner]=[];
      ownerMap[owner].push({symbol:sym,label:lab,cat:n,price,change_pct:pct});
    }
  }
  return {categories:Object.values(cats), ownerMap};
}

function makeChip(it,isTaken){
  const chip=document.createElement('div');
  chip.className="chip"+(isTaken?" taken":"");
  const label=(it.label||"").trim();
  const price=(it.price||"").trim();
  const pct=(it.change_pct||"").trim();
  const own=(it.owner&&isTaken)?`<span class="owner">— ${it.owner}</span>`:"";
  let pricePart=price?`<small>$${parseFloat(price).toFixed(2)}</small>`:"";
  let pctPart=pct?`<small style="color:${parseFloat(pct)>=0?'#50e3c2':'#ff6b6b'}">${parseFloat(pct).toFixed(2)}%</small>`:"";
  chip.innerHTML=`<strong>${(it.symbol||"").trim()}</strong> ${label?`<small>${label}</small>`:""} ${pricePart} ${pctPart} ${own}`;
  return chip;
}

function renderBoard(categories){
  const top=document.getElementById('grid-top');
  const def=document.getElementById('defense-footer');
  top.innerHTML=""; def.innerHTML="";
  let defense=null; const topCats=[];
  categories.forEach(c=>{
    if(/defense/i.test(c.name||"")) defense=c;
    else topCats.push(c);
  });
  topCats.forEach(cat=>{
    const card=document.createElement('div'); card.className="card";
    const h2=document.createElement('h2'); h2.textContent=cat.name; card.appendChild(h2);
    const chips=document.createElement('div'); chips.className="chips";
    cat.open.forEach(it=>chips.appendChild(makeChip(it,false)));
    cat.taken.forEach(it=>chips.appendChild(makeChip(it,true)));
    card.appendChild(chips); top.appendChild(card);
  });
  if(defense){
    const h2=document.createElement('h2'); h2.textContent=defense.name; def.appendChild(h2);
    const chips=document.createElement('div'); chips.className="chips";
    defense.open.forEach(it=>chips.appendChild(makeChip(it,false)));
    defense.taken.forEach(it=>chips.appendChild(makeChip(it,true)));
    def.appendChild(chips);
  }
}

function renderOwners(ownerMap){
  const container=document.getElementById('owners');
  container.innerHTML="";
  const owners=Object.keys(ownerMap).sort();
  if(owners.length===0){container.innerHTML=`<div style="color:var(--muted);font-size:13px">No picks yet.</div>`;return;}
  owners.forEach(name=>{
    const oc=document.createElement('div'); oc.className="ownerCard";
    const h3=document.createElement('h3'); h3.textContent=name; oc.appendChild(h3);
    const list=document.createElement('div'); list.className="ownerList";
    ownerMap[name].forEach(it=>{
      const chip=document.createElement('div'); chip.className="chip taken";
      const color=(parseFloat(it.change_pct)>=0?'#50e3c2':'#ff6b6b');
      chip.innerHTML=`<strong>${it.symbol}</strong> <small>${it.label}</small> <small>$${parseFloat(it.price).toFixed(2)}</small> <small style="color:${color}">${parseFloat(it.change_pct).toFixed(2)}%</small>`;
      list.appendChild(chip);
    });
    oc.appendChild(list); container.appendChild(oc);
  });
}

async function sync(){
  try{
    const res=await fetch(CSV_URL+((CSV_URL.includes("?")?"&":"?")+"cachebust="+Date.now()));
    const text=await res.text();
    const {categories,ownerMap}=parseCSV(text);
    renderBoard(categories);
    renderOwners(ownerMap);
  }catch(e){console.error(e);}
}
sync(); setInterval(sync,POLL_MS);
</script>
</body>
</html>
