<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Wheels Fantasy Stock Ball — Live Draft Board</title>
<style>
  :root{
    --bg: rgba(10,12,16,0.45);
    --panel: rgba(24,28,36,0.82);
    --text: #eaf0ff;
    --muted: #9fb0d0;
    --accent: #50e3c2;
    --taken:#ff6b6b;
    --chip:#1e2533;
    --chip-border:#2b3447;
    --owner:#86b5ff;
    --gain:#28c76f;
    --loss:#ff6b6b;
  }
  html,body{
    margin:0; padding:0; background:transparent;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
    color:var(--text);
  }
  .wrap{
    position:relative; padding:16px; background:var(--bg); border-radius:16px; overflow:hidden;
    backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
  }

  /* Header + logos */
  header{position:relative; display:flex; align-items:center; gap:12px; margin-bottom:10px; z-index:2;}
  .logos{display:flex; align-items:center; gap:8px}
  img.logo{height:34px; width:auto; object-fit:contain; display:block}
  img.logo.stock{height:26px; opacity:.9}
  header h1{font-size:22px;margin:0;letter-spacing:.35px; font-weight:800}

  .legend{position:relative; display:flex; gap:12px; align-items:center; margin:6px 0 12px; color:var(--muted); font-size:13px; z-index:2}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot-open{background:var(--accent)} .dot-taken{background:var(--taken)}

  /* Main layout: left board + right column */
  .layout{
    position:relative;
    display:grid;
    grid-template-columns: 3.2fr 0.8fr; /* narrower right column */
    gap:12px; align-items:start; z-index:2;
  }

  /* Left board: 4 fixed columns (QB, RB, WR, TE) */
  .grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(230px, 1fr));
    gap:12px;
  }

  .card{background:var(--panel); border:1px solid #2a3346; border-radius:14px; padding:12px; min-height:80px}
  .card h2{margin:0 0 10px; font-size:16px; font-weight:800; letter-spacing:.35px; color:var(--accent)}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; background:var(--chip);
    border:1px solid var(--chip-border); border-radius:999px;
    user-select:none; transition:all .2s; font-weight:700; white-space:nowrap;
  }
  .chip small{color:var(--muted); font-weight:600}
  .chip.taken{
    opacity:1; border-color:#3b1f24; background:#26171a; color:#ffdede;
  }
  .chip .owner{font-weight:700; color:var(--owner); margin-left:6px; opacity:.95}
  .price{opacity:.9}
  .chg{font-weight:800}
  .up{color:var(--gain)} .down{color:var(--loss)}

  /* Right column: picks + defense */
  .rightCol{display:flex; flex-direction:column; gap:12px; min-width:270px}

  /* Watermark, centered behind everything */
  .wm{
    position:fixed; inset:0; z-index:0; pointer-events:none; user-select:none;
    display:flex; align-items:center; justify-content:center;
  }
  .wm img{
    width:min(92vw, 92vh); /* fill but keep within screen */
    height:auto; opacity:0.22; filter:grayscale(5%) brightness(1.1) contrast(110%);
  }

 /* Compact mode: smaller chips + tighter layout */
body.compact header h1{font-size:18px}
body.compact .wrap{padding:10px}
body.compact .card{padding:8px}
body.compact .card h2{font-size:14px;margin-bottom:6px}
body.compact .chips{gap:5px}
body.compact .chip{
  padding:4px 6px;
  font-size:12px;
  font-weight:700;
  border-radius:999px;
}
body.compact .chip small{font-size:10px}
body.compact .price{font-size:11px}
body.compact .chg{font-size:10px}
body.compact .logos img.logo{height:28px}
body.compact .logos img.logo.stock{height:22px}
body.compact .legend{font-size:11px; gap:8px}
body.compact .grid{
  grid-template-columns: repeat(4, minmax(210px, 1fr));
  gap:10px;
}
body.compact .layout{
  grid-template-columns: 3.05fr 0.95fr;
}

</style>
</head>
<body>
  <!-- Watermark -->
  <div class="wm"><img id="wm" alt="Trading Wheels Watermark"></div>

  <div class="wrap">
    <header>
      <div class="logos">
        <img id="twLogo" class="logo tw" alt="Trading Wheels"/>
        <img id="stockLogo" class="logo stock" alt="Stock"/>
      </div>
      <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
    </header>

    <div class="legend">
      <div class="dot dot-open"></div><span>Available</span>
      <div class="dot dot-taken"></div><span>Taken</span>
    </div>

    <div class="layout">
      <!-- LEFT: main board -->
      <div>
        <div class="grid" id="grid-top"></div>
      </div>

      <!-- RIGHT: picks by owner (top) + defense (bottom) -->
      <div class="rightCol">
        <div class="card">
          <h2>Picks by Owner</h2>
          <div id="owners" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>

        <div class="card">
          <h2 id="def-title">Defense (Defensive)</h2>
          <div id="def-chips" class="chips"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---- Params ---- */
const p = new URLSearchParams(location.search);
const CSV_URL   = p.get("csv") || "";
const TW_LOGO   = p.get("twlogo")    || "Trading Wheels.png";
const STOCKLOGO = p.get("stocklogo") || "stock_logo.png";
const COMPACT   = p.get("compact")   === "1";
const POLL_MS   = 5000;

/* ---- Apply logos + compact ---- */
const twLogoEl = document.getElementById("twLogo");
const stockLogoEl = document.getElementById("stockLogo");
const wmEl = document.getElementById("wm");

twLogoEl.src = TW_LOGO;
stockLogoEl.src = STOCKLOGO;
wmEl.src = TW_LOGO;

if (COMPACT) document.body.classList.add("compact");

/* ---- CSV parse helpers ---- */
function csvParseLine(line){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; }
      else inQ = !inQ;
    }else if(ch===',' && !inQ){
      out.push(cur); cur="";
    }else cur+=ch;
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
  const rows  = lines.map(csvParseLine);

  // Expect headers: category_key, category_name, symbol, label, taken, owner, price, change_pct
  const cats = {};
  const ownerMap = {};
  let headers = null;

  for (let i=0;i<rows.length;i++){
    const cols = rows[i];
    const c0 = (cols[0]||"").trim().toLowerCase();

    if (c0==="title") continue;           // skip gviz title
    if (!headers && /category_key/i.test(cols[0]||"")) { headers = cols.map(h => (h||"").trim().toLowerCase()); continue; }
    if (!headers) continue;

    const get = (name) => cols[headers.indexOf(name)] || "";
    const k   = get("category_key").trim();
    const n   = get("category_name").trim();
    const sym = get("symbol").trim();
    const lab = get("label").trim();
    const taken   = (get("taken")||"").toString().trim().toLowerCase();
    const owner   = get("owner").trim();
    const price   = (get("price")||"").trim();
    const chg     = (get("change_pct")||"").trim();

    if(!(k && n && sym)) continue;

    if(!cats[k]) cats[k] = {name:n, key:k, open:[], taken:[]};

    const isTaken = (taken==="1"||taken==="true"||taken==="yes"||taken==="y");
    const item = {symbol:sym, label:lab, owner, price, chg};
    (isTaken ? cats[k].taken : cats[k].open).push(item);

    if(isTaken && owner){
      if(!ownerMap[owner]) ownerMap[owner] = [];
      ownerMap[owner].push({symbol:sym,label:lab,price,chg,cat:n});
    }
  }

  return {categories:Object.values(cats), ownerMap};
}

/* ---- Rendering ---- */
function makeChip(it, isTaken){
  const chip = document.createElement('div');
  chip.className = "chip" + (isTaken ? " taken" : "");
  const label = (it.label||"").trim();
  const price = (it.price||"").trim();
  const chg   = (it.chg||"").trim();
  const own   = (it.owner && isTaken) ? `<span class="owner">— ${it.owner}</span>` : "";

  let chgClass = "";
  if (chg.startsWith("-")) chgClass="down";
  else if (chg.length) chgClass="up";

  chip.innerHTML =
    `<strong>${(it.symbol||"").trim()}</strong>` +
    (price ? ` <span class="price">$${price}</span>` : "") +
    (chg ? ` <span class="chg ${chgClass}">${chg}</span>` : "") +
    (label?` <small>${label}</small>`:"") +
    own;

  return chip;
}

function renderBoard(categories){
  const top = document.getElementById('grid-top'); top.innerHTML="";
  let def = null, others = [];

  categories.forEach(c=>{
    if ((c.key||"").toLowerCase()==="def" || /defense/i.test(c.name||"")) def=c;
    else others.push(c);
  });

  // ensure order QB,RB,WR,TE if keys exist
  const order = ["qb","rb","wr","te"];
  others.sort((a,b)=> order.indexOf(a.key) - order.indexOf(b.key));

  others.forEach(cat=>{
    const card = document.createElement('div'); card.className="card";
    const h2 = document.createElement('h2'); h2.textContent = cat.name; card.appendChild(h2);
    const chips = document.createElement('div'); chips.className="chips";
    cat.open.forEach(it => chips.appendChild(makeChip(it,false)));
    cat.taken.forEach(it => chips.appendChild(makeChip(it,true)));
    card.appendChild(chips); top.appendChild(card);
  });

  // Defense on the right column (already in DOM)
  const defTitle = document.getElementById('def-title');
  const defChips = document.getElementById('def-chips');
  defChips.innerHTML = "";
  if(def){
    defTitle.textContent = def.name || "Defense (Defensive)";
    def.open.forEach(it => defChips.appendChild(makeChip(it,false)));
    def.taken.forEach(it => defChips.appendChild(makeChip(it,true)));
  }else{
    defTitle.textContent = "Defense (Defensive)";
  }
}

function renderOwners(map){
  const box = document.getElementById('owners'); box.innerHTML="";
  const owners = Object.keys(map).sort();
  if(!owners.length){ box.innerHTML = `<div style="color:var(--muted);font-size:13px">No picks yet.</div>`; return; }
  owners.forEach(name=>{
    const sec = document.createElement('div');
    const h = document.createElement('div');
    h.textContent = name; h.style.cssText="color:#b8c8ff;font-weight:800;margin-bottom:6px";
    const list = document.createElement('div'); list.className="chips";
    map[name].forEach(it=>{
      const chip = document.createElement('div'); chip.className="chip taken";
      const chgClass = (it.chg||"").startsWith("-") ? "down" : "up";
      chip.innerHTML =
        `<strong>${it.symbol}</strong>` +
        (it.price?` <span class="price">$${it.price}</span>`:"") +
        (it.chg?` <span class="chg ${chgClass}">${it.chg}</span>`:"") +
        (it.label?` <small>${it.label}</small>`:"");
      list.appendChild(chip);
    });
    sec.appendChild(h); sec.appendChild(list); box.appendChild(sec);
  });
}

/* ---- Poll loop ---- */
async function sync(){
  if(!CSV_URL) return;
  try{
    const res = await fetch(CSV_URL + (CSV_URL.includes("?")?"&":"?") + "cachebust=" + Date.now());
    const text = await res.text();
    const {categories, ownerMap} = parseCSV(text);
    renderBoard(categories);
    renderOwners(ownerMap);
  }catch(e){
    // silent
  }
}
sync(); setInterval(sync, POLL_MS);
</script>
</body>
</html>
