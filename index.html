<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Wheels Fantasy Stock Ball — Live Draft Board</title>
<style>
  :root{
    --bg: rgba(10,12,16,0.45);
    --panel: rgba(24,28,36,0.92);
    --text: #eaf0ff;
    --muted: #9fb0d0;
    --accent: #50e3c2;
    --taken:#ff6b6b;
    --chip:#1e2533;
    --chip-border:#2b3447;
    --owner:#86b5ff;
  }
  html,body{
    margin:0; padding:0; background:transparent;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
    color:var(--text); overflow-x:hidden;
  }
  /* Watermark behind everything */
  .watermark{ position:fixed; inset:0; pointer-events:none; z-index:0; }
  .watermark::after{
    content:""; position:absolute; inset:0;
    background:url("https://raw.githubusercontent.com/kbergh013-spec/trading-wheel-board/main/Trading%20Wheels.png") no-repeat center center;
    background-size:min(115vmin,100vh);
    opacity:0.08; filter:brightness(150%) contrast(105%);
  }
  .wrap{
    position:relative; padding:16px; background:var(--bg);
    border-radius:16px; overflow:hidden;
    backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
    z-index:1;
  }
  header{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .logos{display:flex; align-items:center; gap:8px}
  img.logo{height:34px; width:auto; object-fit:contain}
  img.logo.stock{height:26px; opacity:.9}
  header h1{font-size:22px; margin:0; letter-spacing:.4px; font-weight:800}
  .legend{display:flex; gap:12px; align-items:center; margin:6px 0 12px; color:var(--muted); font-size:13px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot-open{background:var(--accent)} .dot-taken{background:var(--taken)}
  /* Layout: left board + right column (owners + defense) */
  .layout{display:grid; grid-template-columns:3fr 1fr; gap:12px; align-items:start}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:12px}
  .card{background:var(--panel); border:1px solid #2a3346; border-radius:14px; padding:12px; min-height:60px}
  .card h2{margin:0 0 10px; font-size:16px; font-weight:800; letter-spacing:.4px; color:var(--accent)}
  .chips{display:flex; flex-wrap:wrap; gap:6px}
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 8px;
    background:var(--chip); border:1px solid var(--chip-border); border-radius:999px;
    user-select:none; transition:all .2s; font-weight:700;
  }
  .chip small{color:var(--muted); font-weight:600}
  .chip.taken{border-color:#3b1f24; background:#26171a; color:#ffdede}
  .chip .owner{font-weight:700; color:var(--owner); margin-left:4px; opacity:.95}
  .rightCol{display:flex; flex-direction:column; gap:12px}
  .ownerCard h3{margin:0 0 8px; font-size:15px; color:#b8c8ff}
  .ownerList{display:flex; flex-wrap:wrap; gap:6px}
</style>
</head>
<body>
  <div class="watermark"></div>
  <div class="wrap">
    <header>
      <div class="logos">
        <img src="https://raw.githubusercontent.com/kbergh013-spec/trading-wheel-board/main/Trading%20Wheels.png" class="logo tw" alt="Trading Wheels"/>
        <img src="https://raw.githubusercontent.com/kbergh013-spec/trading-wheel-board/main/stock_logo.png" class="logo stock" alt="Stock"/>
      </div>
      <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
    </header>

    <div class="legend">
      <div class="dot dot-open"></div><span>Available</span>
      <div class="dot dot-taken"></div><span>Taken</span>
    </div>

    <div class="layout">
      <div>
        <div class="grid" id="grid-top"></div>
      </div>
      <div class="rightCol">
        <div class="card">
          <h2>Picks by Owner</h2>
          <div class="owners" id="owners"></div>
        </div>
        <div class="card" id="defense-card"></div>
      </div>
    </div>
  </div>

<script>
const params = new URLSearchParams(location.search);

/* 1) CSV can be provided via ?csv=...
      Example:
      https://kbergh013-spec.github.io/trading-wheel-board/?csv=https://docs.google.com/spreadsheets/d/e/.../pub?gid=547264929&single=true&output=csv
*/
const CSV_URL =
  params.get("csv") ||
  // Fallback to your last known good ROSTER CSV:
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRDeqCYumZyn4Tn6snbe96U-4CgCyy6mNSnawQOT4uRpLdz36EIfSuZf_kA3xgFz-3tvR0H8IhD9byR/pub?gid=547264929&single=true&output=csv";

const POLL_MS = 5000;

/* CSV parsing */
function csvParseLine(line){
  const out=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQuotes && line[i+1]==='\"'){cur+='\"'; i++;}
      else inQuotes=!inQuotes;
    }else if(ch===',' && !inQuotes){
      out.push(cur); cur="";
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  return out;
}

function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
  const rows  = lines.map(csvParseLine);

  const cats = {};
  const ownerMap = {};

  for(const cols of rows){
    if(!cols || cols.length===0) continue;
    const c0 = (cols[0]||"").trim().toLowerCase();
    if(c0==="title" || c0==="category_key") continue; // skip Google title/header

    const k      = (cols[0]||"").trim();   // category_key
    const n      = (cols[1]||"").trim();   // category_name
    const sym    = (cols[2]||"").trim();   // symbol
    const lab    = (cols[3]||"").trim();   // label
    const taken  = (cols[4]||"").toString().trim().toLowerCase(); // taken
    const owner  = (cols[5]||"").trim();   // owner
    const price  = (cols[6]||"").trim();   // price
    const change = (cols[7]||"").trim();   // change_pct

    if(!(k && n && sym)) continue; // must have these

    if(!cats[k]) cats[k] = {name:n, key:k, open:[], taken:[]};
    const isTaken = (taken==="1"||taken==="true"||taken==="yes"||taken==="y");
    const item = {symbol:sym, label:lab, owner, price, change};
    (isTaken ? cats[k].taken : cats[k].open).push(item);

    if(isTaken && owner){
      if(!ownerMap[owner]) ownerMap[owner] = [];
      ownerMap[owner].push({symbol:sym,label:lab,cat:n,price,change});
    }
  }

  return {categories:Object.values(cats), ownerMap};
}

/* Rendering */
function makeChip(it,isTaken){
  const chip = document.createElement("div");
  chip.className = "chip" + (isTaken ? " taken" : "");
  const label = it.label ? `<small>${it.label}</small>` : "";
  const price = it.price ? `$${it.price}` : "";
  const num = parseFloat(it.change);
  const chg = isFinite(num) ? ` <small style="color:${num>=0?"#6df5a5":"#ff7a7a"}">${num}%</small>` : "";
  const own = (it.owner && isTaken) ? `<span class="owner">— ${it.owner}</span>` : "";
  chip.innerHTML = `<strong>${it.symbol}</strong> ${label} ${price}${chg} ${own}`;
  return chip;
}

function renderBoard(categories){
  const top = document.getElementById("grid-top"); top.innerHTML = "";
  const def = document.getElementById("defense-card"); def.innerHTML = "";

  let defense = null; const topCats = [];
  categories.forEach(c=>{
    if((c.key||"").toLowerCase()==="def" || /defense/i.test(c.name||"")) defense = c;
    else topCats.push(c);
  });

  topCats.forEach(cat=>{
    const card = document.createElement("div"); card.className = "card";
    const h2 = document.createElement("h2"); h2.textContent = cat.name; card.appendChild(h2);
    const chips = document.createElement("div"); chips.className = "chips";
    cat.open.forEach(it=>chips.appendChild(makeChip(it,false)));
    cat.taken.forEach(it=>chips.appendChild(makeChip(it,true)));
    card.appendChild(chips); top.appendChild(card);
  });

  if(defense){
    const h2 = document.createElement("h2"); h2.textContent = defense.name; def.appendChild(h2);
    const chips = document.createElement("div"); chips.className = "chips";
    defense.open.forEach(it=>chips.appendChild(makeChip(it,false)));
    defense.taken.forEach(it=>chips.appendChild(makeChip(it,true)));
    def.appendChild(chips);
  }
}

function renderOwners(ownerMap){
  const container = document.getElementById("owners"); container.innerHTML = "";
  const owners = Object.keys(ownerMap).sort();
  if(owners.length===0){ container.innerHTML = `<div style="color:var(--muted);font-size:13px">No picks yet.</div>`; return; }
  owners.forEach(name=>{
    const oc = document.createElement("div"); oc.className="ownerCard";
    const h3 = document.createElement("h3"); h3.textContent = name; oc.appendChild(h3);
    const list = document.createElement("div"); list.className="ownerList";
    ownerMap[name].forEach(it=>{
      const chip = document.createElement("div"); chip.className="chip taken";
      const num = parseFloat(it.change);
      const chg = isFinite(num) ? ` <small style="color:${num>=0?"#6df5a5":"#ff7a7a"}">${num}%</small>` : "";
      chip.innerHTML = `<strong>${it.symbol}</strong> <small>${it.label}</small> $${it.price}${chg}`;
      list.appendChild(chip);
    });
    oc.appendChild(list); container.appendChild(oc);
  });
}

/* Sync loop */
async function sync(){
  try{
    const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "cachebust=" + Date.now();
    const res = await fetch(url);
    const t = await res.text();
    const {categories, ownerMap} = parseCSV(t);
    renderBoard(categories);
    renderOwners(ownerMap);
  }catch(e){
    console.error("CSV sync error:", e);
  }
}
sync(); setInterval(sync, POLL_MS);
</script>
</body>
</html>
