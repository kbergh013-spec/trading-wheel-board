<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Trading Wheels â€“ Stage Bubbles</title>
<style>
  :root{
    --panel: rgba(24,28,36,0.30);
    --text:#eaf0ff;
    --accent:#50e3c2;
    --wm-opacity:.85;
  }
  html,body{
    margin:0;
    background:transparent;
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }

  /* Background image */
  .wm{
    position:fixed;
    inset:0;
    z-index:0;
    pointer-events:none;
  }
  .wm img{
    width:100vw;
    height:100vh;
    object-fit:cover;
    opacity:var(--wm-opacity);
    filter:none;
  }

  /* Header */
  header{
    position:relative;
    z-index:1;
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 16px 4px;
  }
  .logos{display:flex;align-items:center;gap:8px}
  img.logo{height:34px;display:none}
  img.logo.stock{height:26px;opacity:.9}
  h1{
    margin:0;
    font-size:26px;
    font-weight:800;
    letter-spacing:.4px;
  }

  /* Main card */
  .wrap{
    position:relative;
    z-index:1;
    padding:8px 16px 16px;
  }
  .card{
    background:var(--panel);
    border:1px solid #2a3346;
    border-radius:16px;
    padding:18px;
    max-width:1800px;
    margin:0 auto;
  }
  .card h2{
    margin:0 0 14px;
    font-size:20px;
    color:var(--accent);
  }

  .chips{
    display:grid;
    gap:14px;
  }

  /* Base bubble style */
  .chip{
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:999px;
    border:1px solid #2b3447;
    background:#1e2533;
    font-weight:900;
    letter-spacing:.45px;
    color:var(--text);
    padding:16px 10px;
    font-size:36px;
  }
  .chip.taken{
    background:#26171a;
    border-color:#3b1f24;
    color:#ffdede;
  }

  /* Size variants controlled by data-size on <html> */
  html[data-size="xl"] .chip{
    font-size:52px;
    padding:24px 10px;
  }
  html[data-size="lg"] .chip{
    font-size:42px;
    padding:20px 10px;
  }
  html[data-size="md"] .chip{
    font-size:32px;
    padding:16px 10px;
  }
  html[data-size="sm"] .chip{
    font-size:26px;
    padding:14px 10px;
  }
  html[data-size="xs"] .chip{
    font-size:20px;
    padding:12px 8px;
  }

  @media (max-width: 1400px){
    .chip{font-size:90%}
  }
</style>
</head>
<body>
  <!-- Background -->
  <div class="wm"><img id="bg" alt="Background"></div>

  <header>
    <div class="logos">
      <img id="twLogo" class="logo" alt="Trading Wheels">
      <img id="xLogo"  class="logo stock" alt="X logo">
    </div>
    <h1 id="pageTitle">Trading Wheels Board</h1>
  </header>

  <div class="wrap">
    <div class="card">
      <h2 id="cardTitle"></h2>
      <div id="chips" class="chips"></div>
    </div>
  </div>

<script>
const params   = new URLSearchParams(location.search);

/* URL params */
const CSV_URL  = params.get("csv") || "";
const ROWS     = parseInt(params.get("rows") || "3", 10); // not strictly needed, but kept for future use
const COLS     = parseInt(params.get("cols") || "4", 10);
const SIZE     = (params.get("size") || "lg").toLowerCase();
const TITLE    = params.get("title") || "Trading Wheels Board";

const TW_LOGO  = params.get("twlogo")   || "Trading Wheels.png";
const X_LOGO   = params.get("stocklogo")|| "stock_logo.png";
const BG_IMAGE = params.get("bg")       || "Fantasy_Background.png";

/* Apply size to <html> for CSS */
document.documentElement.setAttribute("data-size", SIZE);

/* Set titles and images */
document.getElementById("pageTitle").textContent = TITLE;
document.getElementById("cardTitle").textContent = TITLE;

const twLogoEl = document.getElementById("twLogo");
const xLogoEl  = document.getElementById("xLogo");
const bgEl     = document.getElementById("bg");

twLogoEl.src = TW_LOGO;  twLogoEl.style.display = "block";
xLogoEl.src  = X_LOGO;   xLogoEl.style.display  = "block";
bgEl.src     = BG_IMAGE;

/* Simple CSV parser */
function parseCSV(text){
  text = text.replace(/^\uFEFF/, "");
  const lines = text.split(/\r?\n/).filter(Boolean);
  const rows  = [];
  for(const line of lines){
    let inQ = false, cur = "", cells = [];
    for(let i=0; i<line.length; i++){
      const ch = line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      }else if(ch === ',' && !inQ){
        cells.push(cur); cur="";
      }else{
        cur += ch;
      }
    }
    cells.push(cur);
    rows.push(cells);
  }
  return rows;
}

/* Render chips */
function render(rows){
  const box = document.getElementById("chips");
  box.innerHTML = "";

  // set column count from COLS param
  box.style.gridTemplateColumns = `repeat(${COLS}, 1fr)`;

  for(const r of rows){
    const key = (r[0]||"").trim().toLowerCase();
    if(key === "title" || key === "category_key") continue;

    const sym   = (r[2]||"").trim();
    if(!sym) continue;
    const taken = (r[4]||"").toString().trim().toLowerCase();
    const isTaken = (taken==="1"||taken==="true"||taken==="yes"||taken==="y");

    const el = document.createElement("div");
    el.className = "chip" + (isTaken ? " taken" : "");
    el.textContent = sym;
    box.appendChild(el);
  }
}

/* Polling loop */
async function sync(){
  if(!CSV_URL) return;
  try{
    const res = await fetch(CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "cachebust=" + Date.now());
    const txt = await res.text();
    const rows = parseCSV(txt);
    render(rows);
  }catch(e){
    console.error(e);
  }
}
sync();
setInterval(sync, 5000);
</script>
</body>
</html>
