<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Trading Wheels – Picks Board</title>
<style>
  :root{
    --panel: rgba(24,28,36,0.30);
    --text:#eaf0ff;
    --muted:#9fb0d0;
    --accent:#50e3c2;
    --wm-opacity:.85;
  }

  html,body{
    margin:0;
    background:transparent;
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }

  /* Background image – same style as other boards */
  .wm{
    position:fixed;
    inset:0;
    z-index:0;
    pointer-events:none;
  }
  .wm img{
    width:100vw;
    height:100vh;
    object-fit:cover;
    opacity:var(--wm-opacity);
    filter:none;
  }

  /* Header bar – same as stage_bubbles */
  header{
    position:relative;
    z-index:1;
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 16px 4px;
  }
  .logos{display:flex;align-items:center;gap:8px}
  img.logo{height:34px;display:none}
  img.logo.stock{height:26px;opacity:.9}
  h1{
    margin:0;
    font-size:26px;
    font-weight:800;
    letter-spacing:.4px;
  }

  /* Main wrapper */
  .wrap{
    position:relative;
    z-index:1;
    padding:8px 16px 16px;
  }

  /* Outer card (like category card on stage_bubbles) */
  .board-card{
    background:var(--panel);
    border:1px solid #2a3346;
    border-radius:16px;
    padding:18px;
    max-width:1800px;
    margin:0 auto;
  }

  /* Neon page title */
  #cardTitle{
    margin:0 0 20px;
    font-size:32px;
    font-weight:900;
    text-align:center;
    color:var(--accent);
    text-shadow:0 0 18px rgba(80,227,194,0.9);
    letter-spacing:.5px;
  }

  /* Grid of owner cards */
  .owners-grid{
    display:grid;
    gap:16px;
    grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
  }

  .ownerCard{
    background:rgba(10,14,22,0.55);
    border-radius:14px;
    border:1px solid #2a3346;
    padding:12px 14px 14px;
  }

  .ownerCard h2{
    margin:0 0 10px;
    font-size:18px;
    color:var(--accent);
    display:flex;
    justify-content:space-between;
    align-items:baseline;
  }
  .ownerCard h2 span{
    font-size:12px;
    color:var(--muted);
    font-weight:500;
    margin-left:8px;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  /* Bubble chips (smaller than category boards but same style) */
  .chip{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:999px;
  border:1px solid #2b3447;
  background:#1e2533;
  font-weight:900;
  letter-spacing:.4px;
  color:var(--text);
  padding:30px 40px;   /* increased padding for bigger pill shape */
  font-size:32px;      /* larger text size */
  white-space:nowrap;
  margin:10px;         /* more breathing room between bubbles */
  min-width:160px;       /* ensures consistent bubble size */
}

  }
  .chip small{
    font-size:11px;
    font-weight:600;
    color:var(--muted);
    margin-left:6px;
    text-transform:uppercase;
  }

  .empty-msg{
    color:var(--muted);
    font-size:14px;
    text-align:center;
    margin-top:24px;
  }
</style>
</head>
<body>
  <!-- Background -->
  <div class="wm"><img id="bg" alt="Background"></div>

  <!-- Same header bar as other boards -->
  <header>
    <div class="logos">
      <img id="twLogo" class="logo" alt="Trading Wheels">
      <img id="xLogo"  class="logo stock" alt="X logo">
    </div>
    <h1>Trading Wheels Fantasy Stock Ball — Live Draft Board</h1>
  </header>

  <div class="wrap">
    <div class="board-card">
      <!-- Neon “Picks Board” title -->
      <h2 id="cardTitle">Picks Board</h2>

      <!-- Owners grid -->
      <div id="ownersGrid" class="owners-grid"></div>
      <div id="emptyMsg" class="empty-msg" style="display:none;">
        No picks yet. Once owners start drafting, their stocks will appear here.
      </div>
    </div>
  </div>

<script>
/* ====== Params & config ====== */
const params   = new URLSearchParams(location.search);

/* Same sheet as your other boards */
const SHEET_ID = "10eCZI1tLui-KwHQDRFRnsZXghM_jf5MX8zdlCZkI-Os";

/* Allow overriding CSV via ?csv=, but default is full * (all columns) */
let CSV_URL    = params.get("csv") || "";
if (!CSV_URL) {
  const tq = encodeURIComponent("select *"); // grab all columns, we'll map by header name
  CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tq=${tq}&tqx=out:csv`;
}

/* Logos & background (same pattern as other pages) */
const TW_LOGO  = params.get("twlogo")   || "Trading Wheels.png";
const X_LOGO   = params.get("stocklogo")|| "stock_logo.png";
const BG_IMAGE = params.get("bg")       || "Fantasy_Background.png";
const WM_OPAC  = params.get("wm");
if (WM_OPAC && !Number.isNaN(parseFloat(WM_OPAC))) {
  document.documentElement.style.setProperty("--wm-opacity", parseFloat(WM_OPAC));
}

document.getElementById("twLogo").src = TW_LOGO;
document.getElementById("twLogo").style.display = "block";
document.getElementById("xLogo").src  = X_LOGO;
document.getElementById("xLogo").style.display  = "block";
document.getElementById("bg").src     = BG_IMAGE;

/* ====== CSV parsing ====== */
function parseCSV(text){
  text = text.replace(/^\uFEFF/, "");
  const lines = text.split(/\r?\n/).filter(Boolean);
  const rows  = [];
  for(const line of lines){
    let inQ = false, cur = "", cells = [];
    for(let i=0; i<line.length; i++){
      const ch = line[i];
      if(ch === '"'){
        if(inQ && line[i+1]==='"'){ cur += '"'; i++; }
        else inQ = !inQ;
      }else if(ch === ',' && !inQ){
        cells.push(cur); cur="";
      }else{
        cur += ch;
      }
    }
    cells.push(cur);
    rows.push(cells);
  }
  return rows;
}

/* ====== Helper: detect column indexes by header name ====== */
function detectColumns(rows){
  // defaults (if we can't find headers)
  let idxKey   = 0;
  let idxCat   = 1;
  let idxSym   = 2;
  let idxTaken = 4;
  let idxOwner = 5;

  if(!rows.length) return {idxKey,idxCat,idxSym,idxTaken,idxOwner};

  // look for a header row where first cell is "category_key"
  let header = null;
  for(const r of rows){
    if(!r.length) continue;
    const c0 = (r[0]||"").trim().toLowerCase();
    if(c0 === "category_key"){
      header = r;
      break;
    }
  }
  if(!header) return {idxKey,idxCat,idxSym,idxTaken,idxOwner};

  const lower = header.map(c => (c||"").trim().toLowerCase());

  function findIndex(name, fallback){
    const i = lower.indexOf(name);
    return i >= 0 ? i : fallback;
  }

  idxKey   = findIndex("category_key", idxKey);
  idxCat   = findIndex("category_name", idxCat);
  idxSym   = findIndex("symbol",       idxSym);
  idxTaken = findIndex("taken",        idxTaken);
  idxOwner = findIndex("owner",        idxOwner);

  return {idxKey,idxCat,idxSym,idxTaken,idxOwner, header};
}

/* ====== Build picks by owner ====== */
/* Works even if columns are reordered, as long as headers exist */
function buildPicks(rows){
  const owners = {}; // { ownerName: [{symbol, cat}] }

  const {idxKey,idxCat,idxSym,idxTaken,idxOwner, header} = detectColumns(rows);

  for(const r of rows){
    if(!r || r.length < 3) continue;

    // skip the header row itself if we identified it
    if(header && r === header) continue;

    const c0 = (r[idxKey]||"").trim().toLowerCase();
    if(c0 === "title" || c0 === "category_key") continue;

    const catKey  = (r[idxKey]  ||"").trim();
    const catName = (r[idxCat]  ||"").trim();
    const sym     = (r[idxSym]  ||"").trim();
    const taken   = (r[idxTaken]||"").toString().trim().toLowerCase();
    const owner   = (r[idxOwner]||"").trim();

    if(!sym || !owner) continue;

    const isTaken = (taken==="1" || taken==="true" || taken==="yes" || taken==="y");
    if(!isTaken) continue;

    if(!owners[owner]) owners[owner] = [];
    owners[owner].push({symbol:sym, cat:catName || catKey});
  }

  return owners;
}

/* ====== Render ====== */
function renderOwners(owners){
  const grid  = document.getElementById("ownersGrid");
  const empty = document.getElementById("emptyMsg");
  grid.innerHTML = "";

  const names = Object.keys(owners).sort((a,b)=>a.localeCompare(b));
  if(!names.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  for(const name of names){
    const picks = owners[name];
    const card  = document.createElement("div");
    card.className = "ownerCard";

    const h2 = document.createElement("h2");
    const titleSpan = document.createElement("span");

    h2.textContent = name;
    titleSpan.textContent = `${picks.length} pick${picks.length===1?"":"s"}`;
    h2.appendChild(titleSpan);
    card.appendChild(h2);

    const chips = document.createElement("div");
    chips.className = "chips";

    picks.forEach(p => {
      const el = document.createElement("div");
      el.className = "chip";
      el.innerHTML = `
  <span style="margin-right:10px;">${p.symbol}</span>
  <span style="font-size:0.8em; opacity:0.8;">${p.cat}</span>
`;
      chips.appendChild(el);
    });

    card.appendChild(chips);
    grid.appendChild(card);
  }
}

/* ====== Poll loop ====== */
async function sync(){
  try{
    if(!CSV_URL) return;
    const res  = await fetch(
      CSV_URL + (CSV_URL.includes("?")?"&":"?") + "cachebust=" + Date.now()
    );
    const text = await res.text();
    const rows = parseCSV(text);
    const owners = buildPicks(rows);
    renderOwners(owners);
  }catch(err){
    console.error("Picks sync failed:", err);
  }
}

sync();
setInterval(sync, 5000);
</script>
</body>
</html>
